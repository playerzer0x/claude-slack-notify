#!/bin/bash
# =============================================================================
# slack-tunnel - Start ngrok tunnel for Slack button actions
#
# This script:
# 1. Installs ngrok if not present
# 2. Configures ngrok auth token if needed
# 3. Starts the MCP server if not running
# 4. Creates an ngrok tunnel and displays the URL for Slack configuration
# =============================================================================

set -uo pipefail

MCP_PORT=8463
CLAUDE_DIR="$HOME/.claude"
MCP_SERVER="$CLAUDE_DIR/bin/mcp-server"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

echo_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
echo_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
echo_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Check if ngrok is installed
install_ngrok() {
    echo_info "Installing ngrok..."

    if [[ "$(uname)" == "Darwin" ]]; then
        # macOS
        if command -v brew &>/dev/null; then
            brew install ngrok/ngrok/ngrok
        else
            echo_error "Homebrew not found. Install ngrok manually:"
            echo "  https://ngrok.com/download"
            exit 1
        fi
    elif [[ "$(uname)" == "Linux" ]]; then
        # Linux - try apt first, then snap
        if command -v apt-get &>/dev/null; then
            curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
            echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
            sudo apt-get update && sudo apt-get install ngrok
        elif command -v snap &>/dev/null; then
            sudo snap install ngrok
        else
            echo_error "Could not install ngrok automatically. Install manually:"
            echo "  https://ngrok.com/download"
            exit 1
        fi
    else
        echo_error "Unsupported OS. Install ngrok manually:"
        echo "  https://ngrok.com/download"
        exit 1
    fi

    echo_info "ngrok installed successfully"
}

# Check ngrok auth token
setup_ngrok_auth() {
    # Try to check if auth is configured
    if ! ngrok config check &>/dev/null 2>&1; then
        echo ""
        echo -e "${YELLOW}╭────────────────────────────────────────────────────────────╮${NC}"
        echo -e "${YELLOW}│${NC}  ${BOLD}ngrok requires a free auth token${NC}                          ${YELLOW}│${NC}"
        echo -e "${YELLOW}╰────────────────────────────────────────────────────────────╯${NC}"
        echo ""
        echo -e "  ${CYAN}1.${NC} Sign up (free) at: ${BOLD}https://dashboard.ngrok.com/signup${NC}"
        echo -e "  ${CYAN}2.${NC} Copy your authtoken from: ${BOLD}https://dashboard.ngrok.com/get-started/your-authtoken${NC}"
        echo ""
        echo -ne "  ${YELLOW}?${NC} Paste your ngrok authtoken: "
        read -r token

        if [[ -z "$token" ]]; then
            echo_error "No token provided. Cannot continue."
            exit 1
        fi

        ngrok config add-authtoken "$token"
        echo_info "ngrok auth token configured"
    fi
}

# Check if MCP server is running
check_mcp_server() {
    if curl -s "http://localhost:$MCP_PORT/health" &>/dev/null; then
        return 0
    fi
    return 1
}

# Start MCP server
start_mcp_server() {
    if [[ ! -x "$MCP_SERVER" ]]; then
        echo_error "MCP server not found at $MCP_SERVER"
        echo_error "Run install.sh first to build the MCP server"
        exit 1
    fi

    echo_info "Starting MCP server..."
    nohup "$MCP_SERVER" > "$CLAUDE_DIR/mcp-server.log" 2>&1 &
    MCP_PID=$!
    echo "$MCP_PID" > "$CLAUDE_DIR/.mcp-server.pid"

    # Wait for server to start
    for i in {1..10}; do
        if check_mcp_server; then
            echo_info "MCP server started (PID: $MCP_PID)"
            return 0
        fi
        sleep 0.5
    done

    echo_error "MCP server failed to start. Check $CLAUDE_DIR/mcp-server.log"
    exit 1
}

# Cleanup on exit
cleanup() {
    if [[ -n "${NGROK_PID:-}" ]]; then
        kill "$NGROK_PID" 2>/dev/null || true
    fi
}
trap cleanup EXIT

# Main
main() {
    echo ""
    echo -e "${BOLD}Slack Tunnel for Claude Notifications${NC}"
    echo -e "${DIM}Creates a public URL for Slack button actions${NC}"
    echo ""

    # Step 1: Check ngrok
    if ! command -v ngrok &>/dev/null; then
        install_ngrok
    fi

    # Step 2: Check auth
    setup_ngrok_auth

    # Step 3: Check MCP server
    if ! check_mcp_server; then
        start_mcp_server
    else
        echo_info "MCP server already running on port $MCP_PORT"
    fi

    # Step 4: Start ngrok
    echo_info "Starting ngrok tunnel..."
    echo ""

    # Start ngrok and get the URL
    TUNNEL_URL=""

    # Start ngrok in background
    ngrok http "$MCP_PORT" --log=stdout --log-format=json > "$CLAUDE_DIR/.ngrok.log" 2>&1 &
    NGROK_PID=$!

    # Wait for URL to appear in logs
    for i in {1..30}; do
        if [[ -f "$CLAUDE_DIR/.ngrok.log" ]]; then
            TUNNEL_URL=$(grep -oE '"url":"https://[^"]+' "$CLAUDE_DIR/.ngrok.log" 2>/dev/null | head -1 | cut -d'"' -f4 || true)
            if [[ -n "$TUNNEL_URL" && "$TUNNEL_URL" == https://* ]]; then
                break
            fi
        fi
        sleep 0.5
    done

    if [[ -z "$TUNNEL_URL" ]]; then
        echo_error "Failed to get ngrok tunnel URL"
        cat "$CLAUDE_DIR/.ngrok.log" 2>/dev/null | tail -5
        exit 1
    fi

    # Display the URL and configuration steps
    echo ""
    echo -e "${CYAN}╭──────────────────────────────────────────────────────────────╮${NC}"
    echo -e "${CYAN}│${NC}                                                              ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}  ${BOLD}Slack Interactivity URL:${NC}                                   ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}                                                              ${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}  ${BOLD}${TUNNEL_URL}/slack/actions${NC}"
    echo -e "${CYAN}│${NC}                                                              ${CYAN}│${NC}"
    echo -e "${CYAN}╰──────────────────────────────────────────────────────────────╯${NC}"
    echo ""
    echo -e "  ${BOLD}Configure your Slack app:${NC}"
    echo -e "  ${CYAN}1.${NC} Go to ${BOLD}https://api.slack.com/apps${NC} → your app"
    echo -e "  ${CYAN}2.${NC} Click ${BOLD}Interactivity & Shortcuts${NC}"
    echo -e "  ${CYAN}3.${NC} Toggle ${BOLD}Interactivity${NC} to On"
    echo -e "  ${CYAN}4.${NC} Paste the URL above into ${BOLD}Request URL${NC}"
    echo -e "  ${CYAN}5.${NC} Click ${BOLD}Save Changes${NC}"
    echo ""

    # Wait for user to confirm
    echo -ne "  ${YELLOW}?${NC} Press ${BOLD}Enter${NC} when you've completed the steps above (or ${BOLD}q${NC} to quit): "
    read -r response

    if [[ "$response" == "q" || "$response" == "Q" ]]; then
        echo_info "Tunnel stopped"
        kill "$NGROK_PID" 2>/dev/null || true
        exit 0
    fi

    # Verify the connection
    echo ""
    echo -e "  ${DIM}Verifying connection...${NC}"

    if curl -sf "${TUNNEL_URL}/health" --max-time 10 >/dev/null 2>&1; then
        echo ""
        echo -e "${GREEN}╭──────────────────────────────────────────────────────────────╮${NC}"
        echo -e "${GREEN}│${NC}  ${GREEN}✓${NC} ${BOLD}Connection verified successfully!${NC}                         ${GREEN}│${NC}"
        echo -e "${GREEN}╰──────────────────────────────────────────────────────────────╯${NC}"
        echo ""
        echo -e "  ${BOLD}You're all set! To start receiving notifications:${NC}"
        echo -e "  Run ${CYAN}/slack-notify${NC} in Claude Code in your preferred terminal"
        echo ""
        echo -e "  ${DIM}Keep this tunnel running. Press Ctrl+C to stop.${NC}"
    else
        echo ""
        echo -e "${RED}╭──────────────────────────────────────────────────────────────╮${NC}"
        echo -e "${RED}│${NC}  ${RED}✗${NC} ${BOLD}Connection verification failed${NC}                            ${RED}│${NC}"
        echo -e "${RED}╰──────────────────────────────────────────────────────────────╯${NC}"
        echo ""
        echo -e "  ${BOLD}Troubleshooting:${NC}"
        echo -e "  ${CYAN}1.${NC} Verify the URL was saved correctly in Slack"
        echo -e "  ${CYAN}2.${NC} Make sure you clicked ${BOLD}Save Changes${NC} in Slack"
        echo -e "  ${CYAN}3.${NC} Check that the MCP server is running: ${DIM}curl http://localhost:${MCP_PORT}/health${NC}"
        echo -e "  ${CYAN}4.${NC} Try the URL directly: ${DIM}curl ${TUNNEL_URL}/health${NC}"
        echo ""
        echo -e "  ${DIM}Press Enter to retry verification, or Ctrl+C to quit${NC}"

        # Allow retry
        while true; do
            read -r
            echo -e "  ${DIM}Retrying...${NC}"
            if curl -sf "${TUNNEL_URL}/health" --max-time 10 >/dev/null 2>&1; then
                echo ""
                echo -e "  ${GREEN}✓${NC} ${BOLD}Connection verified!${NC}"
                echo ""
                echo -e "  ${BOLD}You're all set! To start receiving notifications:${NC}"
                echo -e "  Run ${CYAN}/slack-notify${NC} in Claude Code in your preferred terminal"
                echo ""
                echo -e "  ${DIM}Keep this tunnel running. Press Ctrl+C to stop.${NC}"
                break
            else
                echo -e "  ${RED}✗${NC} Still failing. Press Enter to retry, or Ctrl+C to quit"
            fi
        done
    fi

    # Keep running until interrupted
    wait "$NGROK_PID" 2>/dev/null || true
}

main "$@"
