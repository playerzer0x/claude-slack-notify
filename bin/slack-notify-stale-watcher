#!/bin/bash
# Background watcher for stale Claude responses
# Spawned when Claude finishes and is waiting for user input
# Notifies after DELAY seconds if user hasn't responded

INSTANCE_ID="$1"
WAIT_FILE="$2"
CONTEXT_FILE="$3"
DELAY="${CLAUDE_NOTIFY_STALE_SECONDS:-30}"
QUESTION_OPTS_FILE="/tmp/claude-question-opts-${INSTANCE_ID}.json"
TRANSCRIPT_PATH_FILE="/tmp/claude-transcript-path-${INSTANCE_ID}"

# Validate INSTANCE_ID
if [[ ! "$INSTANCE_ID" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    exit 1
fi

# Sleep for the delay period
sleep "$DELAY"

# Check if the wait file still exists (user hasn't responded yet)
if [[ -f "$WAIT_FILE" ]]; then
    # Read context if available
    CONTEXT=""
    if [[ -f "$CONTEXT_FILE" ]]; then
        CONTEXT=$(cat "$CONTEXT_FILE" 2>/dev/null)
        rm -f "$CONTEXT_FILE"
    fi

    # Clean up wait file
    rm -f "$WAIT_FILE"

    # Check for question options file (for dynamic buttons)
    # If not already created, try to extract from transcript now
    QUESTION_OPTS=""
    if [[ ! -f "$QUESTION_OPTS_FILE" ]]; then
        # Read transcript path from file (saved by slack-notify-waiting)
        TRANSCRIPT=""
        if [[ -f "$TRANSCRIPT_PATH_FILE" ]]; then
            TRANSCRIPT=$(cat "$TRANSCRIPT_PATH_FILE" 2>/dev/null)
            rm -f "$TRANSCRIPT_PATH_FILE"
        fi
        # Fallback: find most recently modified transcript in this project
        if [[ -z "$TRANSCRIPT" || ! -f "$TRANSCRIPT" ]]; then
            TRANSCRIPT=$(ls -t "$HOME/.claude/projects"/*/*.jsonl 2>/dev/null | head -1)
        fi
        if [[ -n "$TRANSCRIPT" && -f "$TRANSCRIPT" ]]; then
            # Use python helper for robust extraction (jq fails on long JSON lines)
            QUESTION_DATA=$("$HOME/.claude/bin/extract-question-opts" "$TRANSCRIPT" 100 2>/dev/null)
            if [[ -n "$QUESTION_DATA" && "$QUESTION_DATA" != "[]" && "$QUESTION_DATA" != "null" ]]; then
                echo "$QUESTION_DATA" > "$QUESTION_OPTS_FILE"
            fi
        fi
    fi

    if [[ -f "$QUESTION_OPTS_FILE" ]]; then
        QUESTION_OPTS="$QUESTION_OPTS_FILE"
    fi

    # Send the notification
    if [[ -n "$CONTEXT" ]]; then
        CLAUDE_INSTANCE_ID="$INSTANCE_ID" CLAUDE_QUESTION_OPTS_FILE="$QUESTION_OPTS" "$HOME/.claude/bin/claude-slack-notify" "Waiting for your response (${DELAY}s)" "waiting" "$CONTEXT"
    else
        CLAUDE_INSTANCE_ID="$INSTANCE_ID" CLAUDE_QUESTION_OPTS_FILE="$QUESTION_OPTS" "$HOME/.claude/bin/claude-slack-notify" "Waiting for your response (${DELAY}s)" "waiting"
    fi

    # Clean up question opts file after notification sent
    rm -f "$QUESTION_OPTS_FILE"
fi
