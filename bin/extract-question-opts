#!/usr/bin/env python3
"""Extract AskUserQuestion options from Claude transcript for Slack buttons."""
import json
import sys

def extract_question_opts(transcript_path, num_lines=500):
    """Extract question options ONLY from the MOST RECENT assistant message.

    Returns questions only if the latest assistant message contains AskUserQuestion.
    This prevents showing stale buttons from old questions in the transcript history.
    """
    try:
        with open(transcript_path, 'r') as f:
            lines = f.readlines()[-num_lines:]
    except Exception:
        return []

    # Find the MOST RECENT assistant message (first one when iterating in reverse)
    for line in reversed(lines):
        try:
            obj = json.loads(line.strip())
            if obj.get('type') != 'assistant':
                continue
            # This is the most recent assistant message - check if it has AskUserQuestion
            content = obj.get('message', {}).get('content', [])
            for item in content:
                if item.get('type') == 'tool_use' and item.get('name') == 'AskUserQuestion':
                    questions = item.get('input', {}).get('questions', [])
                    return [{
                        'question': q.get('question', ''),
                        'header': q.get('header', ''),
                        'multiSelect': q.get('multiSelect', False),
                        'options': [
                            {'label': opt.get('label', ''), 'description': opt.get('description', '')}
                            for opt in q.get('options', [])
                        ]
                    } for q in questions]
            # Most recent assistant message doesn't have AskUserQuestion - return empty
            return []
        except json.JSONDecodeError:
            continue

    return []

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("[]")
        sys.exit(0)

    transcript_path = sys.argv[1]
    num_lines = int(sys.argv[2]) if len(sys.argv) > 2 else 500

    result = extract_question_opts(transcript_path, num_lines)
    print(json.dumps(result))
