#!/bin/bash
# Hook wrapper for Stop - checks elapsed time and notifies if needed
# Extracts session_id from stdin JSON (provided by Claude Code hooks) to use as instance ID

STDIN_DATA=$(cat)

# Try jq first, fall back to grep/sed if not available
if command -v jq &>/dev/null; then
    SESSION_ID=$(echo "$STDIN_DATA" | jq -r '.session_id // empty' 2>/dev/null)
else
    # Fallback: extract session_id using grep/sed (works for simple JSON)
    SESSION_ID=$(echo "$STDIN_DATA" | grep -o '"session_id":"[^"]*"' | sed 's/"session_id":"//;s/"$//' 2>/dev/null)
fi

if [[ -n "$SESSION_ID" ]]; then
    # Pass stdin data through for transcript access (used to extract context message)
    echo "$STDIN_DATA" | CLAUDE_INSTANCE_ID="$SESSION_ID" "$HOME/.claude/bin/claude-slack-notify" check
else
    "$HOME/.claude/bin/claude-slack-notify" check
fi

# On Linux, stop remote-tunnel when session ends
if [[ "$(uname)" == "Linux" ]]; then
    REMOTE_TUNNEL="$HOME/.claude/bin/remote-tunnel"
    if [[ -x "$REMOTE_TUNNEL" ]]; then
        "$REMOTE_TUNNEL" --stop >/dev/null 2>&1 || true
    fi
fi
