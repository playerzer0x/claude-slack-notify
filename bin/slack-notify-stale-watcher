#!/bin/bash
# Background watcher for stale Claude responses
# Spawned when Claude finishes and is waiting for user input
# Notifies after DELAY seconds if user hasn't responded

INSTANCE_ID="$1"
WAIT_FILE="$2"
CONTEXT_FILE="$3"
DELAY="${CLAUDE_NOTIFY_STALE_SECONDS:-30}"
QUESTION_OPTS_FILE="/tmp/claude-question-opts-${INSTANCE_ID}.json"

# Validate INSTANCE_ID
if [[ ! "$INSTANCE_ID" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    exit 1
fi

# Sleep for the delay period
sleep "$DELAY"

# Check if the wait file still exists (user hasn't responded yet)
if [[ -f "$WAIT_FILE" ]]; then
    # Read context if available
    CONTEXT=""
    if [[ -f "$CONTEXT_FILE" ]]; then
        CONTEXT=$(cat "$CONTEXT_FILE" 2>/dev/null)
        rm -f "$CONTEXT_FILE"
    fi

    # Clean up wait file
    rm -f "$WAIT_FILE"

    # Check for question options file (for dynamic buttons)
    # If not already created, try to extract from transcript now
    QUESTION_OPTS=""
    if [[ ! -f "$QUESTION_OPTS_FILE" ]]; then
        # Find transcript for this session
        INSTANCES_DIR="$HOME/.claude/instances"
        INSTANCE_FILE="$INSTANCES_DIR/${INSTANCE_ID}.json"
        if [[ -f "$INSTANCE_FILE" ]]; then
            # Get project path from instance to find transcript
            PROJECT_PATH=$(grep -o '"cwd": *"[^"]*"' "$INSTANCE_FILE" 2>/dev/null | head -1 | cut -d'"' -f4)
            if [[ -n "$PROJECT_PATH" ]]; then
                # Convert path to Claude's project directory format
                SAFE_PATH=$(echo "$PROJECT_PATH" | sed 's|/|-|g; s|^-||')
                TRANSCRIPT=$(ls -t "$HOME/.claude/projects/${SAFE_PATH}"/*.jsonl 2>/dev/null | head -1)
                if [[ -n "$TRANSCRIPT" && -f "$TRANSCRIPT" ]]; then
                    # Extract AskUserQuestion from last 50 lines of transcript
                    QUESTION_DATA=$(tail -50 "$TRANSCRIPT" 2>/dev/null | jq -s -c '
                        [.[] | select(.type == "assistant")] |
                        [.[] | .message.content[]? | select(.type == "tool_use" and .name == "AskUserQuestion")] | last |
                        if . then
                            [.input.questions[]? | {
                                question: .question,
                                header: .header,
                                multiSelect: .multiSelect,
                                options: [.options[]? | {label: .label, description: .description}]
                            }]
                        else
                            []
                        end
                    ' 2>/dev/null)
                    if [[ -n "$QUESTION_DATA" && "$QUESTION_DATA" != "[]" && "$QUESTION_DATA" != "null" ]]; then
                        echo "$QUESTION_DATA" > "$QUESTION_OPTS_FILE"
                    fi
                fi
            fi
        fi
    fi

    if [[ -f "$QUESTION_OPTS_FILE" ]]; then
        QUESTION_OPTS="$QUESTION_OPTS_FILE"
    fi

    # Send the notification
    if [[ -n "$CONTEXT" ]]; then
        CLAUDE_INSTANCE_ID="$INSTANCE_ID" CLAUDE_QUESTION_OPTS_FILE="$QUESTION_OPTS" "$HOME/.claude/bin/claude-slack-notify" "Waiting for your response (${DELAY}s)" "waiting" "$CONTEXT"
    else
        CLAUDE_INSTANCE_ID="$INSTANCE_ID" CLAUDE_QUESTION_OPTS_FILE="$QUESTION_OPTS" "$HOME/.claude/bin/claude-slack-notify" "Waiting for your response (${DELAY}s)" "waiting"
    fi

    # Clean up question opts file after notification sent
    rm -f "$QUESTION_OPTS_FILE"
fi
