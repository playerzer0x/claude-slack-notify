#!/bin/bash
# Hook wrapper for UserPromptSubmit - user is sending input
# 1. Cancels any pending "stale response" watcher (user is no longer idle)
# 2. Starts timing for the current task
# Extracts session_id from stdin JSON (provided by Claude Code hooks) to use as instance ID

STDIN_DATA=$(cat)

# Try jq first, fall back to grep/sed if not available
if command -v jq &>/dev/null; then
    SESSION_ID=$(echo "$STDIN_DATA" | jq -r '.session_id // empty' 2>/dev/null)
else
    # Fallback: extract session_id using grep/sed (works for simple JSON)
    SESSION_ID=$(echo "$STDIN_DATA" | grep -o '"session_id":"[^"]*"' | sed 's/"session_id":"//;s/"$//' 2>/dev/null)
fi

# Require SESSION_ID - don't fall back to unreliable $PPID
if [[ -z "$SESSION_ID" ]]; then
    # No session_id means we can't reliably identify the session - skip silently
    exit 0
fi
INSTANCE_ID="$SESSION_ID"

# Cancel any pending stale-response watcher (user responded, no need to notify)
if [[ "$INSTANCE_ID" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    WAIT_FILE="/tmp/claude-waiting-${INSTANCE_ID}"
    CONTEXT_FILE="/tmp/claude-waiting-ctx-${INSTANCE_ID}"
    WATCHER_PID_FILE="/tmp/claude-watcher-pid-${INSTANCE_ID}"

    # Remove wait marker (signals watcher to not notify)
    rm -f "$WAIT_FILE" "$CONTEXT_FILE"

    # Kill watcher process if still running
    if [[ -f "$WATCHER_PID_FILE" ]]; then
        WATCHER_PID=$(cat "$WATCHER_PID_FILE" 2>/dev/null)
        if [[ -n "$WATCHER_PID" ]] && kill -0 "$WATCHER_PID" 2>/dev/null; then
            kill "$WATCHER_PID" 2>/dev/null
        fi
        rm -f "$WATCHER_PID_FILE"
    fi
fi

# Start timing this task (SESSION_ID is guaranteed non-empty at this point)
CLAUDE_INSTANCE_ID="$SESSION_ID" exec "$HOME/.claude/bin/claude-slack-notify" start
